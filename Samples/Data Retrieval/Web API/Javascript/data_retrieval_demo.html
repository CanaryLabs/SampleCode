<!DOCTYPE html>
<html>
<head>
  <title>Views API Demo</title>
  <meta charset="UTF-8">
  <style>
    * {
      font-family: "calibri"
    }
    
    h1 {
      margin:0;
      padding:0.5rem;
    }
    
    p {
      margin:0;
      padding:0.5rem;
      max-width:600px;
    }
    
    ol {
      margin:0;
      padding:0.5rem;
      padding-left:2.5rem;
      margin-bottom:1.5rem;
      max-width:600px;
    }
    
    li {
      margin:0;
      padding:0;
    }
    
    button {
      margin:0;
      margin-bottom:1rem;
      margin-left:1rem;
      padding:0 1rem;
      width:140px;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
    $(function() {
      // variables
      var userToken = null;
      var liveDataToken = null;
      var tags = [];
      var baseUrls = [
        "http://localhost:55235/api/v1",
        "https://localhost:55236/api/v1"
      ];
      var baseUrl = baseUrls[0];
      
      // api methods
      var apiMethods = {
        "getTimeZones": function() {
          $.ajax({
            url: baseUrl + "/getTimeZones",
            method: "POST"
          }).done(function(data) {
            console.log("getTimeZones", data);
          });
        },
        "getUserToken": function() {
          $.ajax({
            url: baseUrl + "/getUserToken",
            method: "POST",
            data: JSON.stringify({
              "application": "Web API Test",
              "timeZone": "Eastern Standard Time", //"Central Standard Time",
              "username": "name", // ONLY SET WHEN using https:// protocol
              "password": "secret" // ONLY SET WHEN using https:// protocol
            })
          }).done(function(data) {
            console.log("getUserToken", data);
            
            // set user token
            userToken = data.userToken;
          });
        },
        "revokeUserToken": function() {
          $.ajax({
            url: baseUrl + "/revokeUserToken",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken
            })
          }).done(function(data) {
            console.log("revokeUserToken", data);
            
            userToken = null;
          });
        },
        "browseNodes": function(path) {
          $.ajax({
            url: baseUrl + "/browseNodes",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "path": path || ""
            })
          }).done(function(data) {
            console.log("browseNodes", data);
            
            // recursively browse into the first node of each request
            var nodes = data.nodes;
            var keys = Object.keys(nodes);
            if(keys.length > 0) {
              var node = nodes[keys[0]];
              if(node.hasNodes)
                apiMethods["browseNodes"](node.fullPath);
            }
          });
        },
        "browseTags": function(continuation) {
          $.ajax({
            url: baseUrl + "/browseTags",
            method: "POST", 
            data: JSON.stringify({
              "userToken": userToken,
              "deep": true,
              "search": "{Diagnostics}"
              //"path": "optional",
              //"maxSize": 1000,
              //"continuation": continuation || null
            })
          }).done(function(data) {
            console.log("browseTags", data);
            
            // recursively browse more tags
            //if(data.continuation != null)
            //  apiMethods["browseTags"](data.continuation);
            
            // set tags
            tags = data.tags;
          });
        },
        "getAggregates": function() {
          $.ajax({
            url: baseUrl + "/getAggregates",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken
            })
          }).done(function(data) {
            console.log("getAggregates", data);
          });
        },
        "getQualities": function(qualities) {
          $.ajax({
            url: baseUrl + "/getQualities",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "qualities": qualities != undefined ? qualities : [
                192,
                "193",
                32768
              ]
            })
          }).done(function(data) {
            console.log("getQualities", data);
          });
        },
        "getTagProperties": function() {
          $.ajax({
            url: baseUrl + "/getTagProperties",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "tags": tags
            })
          }).done(function(data) {
            console.log("getTagProperties", data);
          });
        },
        "getCurrentValues": function() {
          if(tags.length == 0) {
            alert('Call "BrowseTags" first to build an array of tags used to get data.');
            return;
          }
          
          $.ajax({
            url: baseUrl + "/getTagData",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "tags": tags
              // NOTICE: do not include any additional parameters when requesting current value
            })
          }).done(function(data) {
            console.log("getCurrentValues", data);
          });
        },
        "getRawData": function(continuation) {
          if(tags.length == 0) {
            alert('Call "BrowseTags" first to build an array of tags used to get data.');
            return;
          }
          
          // forward processed data
          $.ajax({
            url: baseUrl + "/getTagData",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "tags": tags,
              "startTime": "Now - 24 Hours", //"2017-12-01T12:00:00.0000000",
              "endTime": "Now", //"2017-12-14T12:00:00.0000000",
              "maxSize": 10000,
              "continuation": continuation || null
              // NOTICE: do not include aggregate parameters when requesting raw data
            })
          }).done(function(data) {
            console.log("getRawData", data);
            
            // call back into function if we have a continuation
            if(data.continuation != null) {
              console.log("CONTINUATION: getRawData", data.continuation);
              apiMethods["getRawData"](data.continuation);
            }
            else
              console.log("FINISHED: getRawData");
          }).fail(function(error) {
            console.log("error", error);
          });
        },
        "getProcessedData": function(continuation) {
          if(tags.length == 0) {
            alert('Call "BrowseTags" first to build an array of tags used to get data.');
            return;
          }
          
          // forward processed data
          $.ajax({
            url: baseUrl + "/getTagData",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "tags": tags,
              "startTime": "Now - 1 Day", //"2017-12-01T12:00:00.0000000",
              "endTime": "Now", //"2017-12-14T12:00:00.0000000",
              "aggregateName": "TimeAverage2",
              "aggregateInterval": "1 Hour",
              "maxSize": 10000,
              "continuation": continuation || null
            })
          }).done(function(data) {
            console.log("getProcessedData", data);
            
            // call back into function if we have a continuation
            if(data.continuation != null) {
              console.log("CONTINUATION: getProcessedData", data.continuation);
              apiMethods["getProcessedData"](data.continuation);
            }
            else
              console.log("FINISHED: getProcessedData");
          }).fail(function(error) {
            console.log("error", error);
          });
        },
        "getLiveDataToken": function() {
          if(tags.length == 0) {
            alert('Call "BrowseTags" first to build an array of tags used to get data.');
            return;
          }
          
          $.ajax({
            url: baseUrl + "/getLiveDataToken",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "tags": tags,
              "mode": "AllValues",
              "includeQuality": true
            })
          }).done(function(data) {
            console.log("getLiveDataToken", data);
            
            liveDataToken = data.liveDataToken;
          });
        },
        "getLiveData": function(continuation) {
          $.ajax({
            url: baseUrl + "/getLiveData",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "liveDataToken": liveDataToken,
              "continuation": continuation || null
            })
          }).done(function(data) {
            console.log("getLiveData", data);
          });
        },
        "revokeLiveDataToken": function() {
          $.ajax({
            url: baseUrl + "/revokeLiveDataToken",
            method: "POST",
            data: JSON.stringify({
              "userToken": userToken,
              "liveDataToken": liveDataToken
            })
          }).done(function(data) {
            console.log("revokeLiveDataToken", data);
            
            liveDataToken = null;
          });
        }
      };
      
      // add buttons
      var buttons = "";
      for(var key in apiMethods)
        buttons += '<button>' + key + '</button><br>';
      $('body').append(buttons);
      
      // add event listeners
      $('body').on('click', 'button', function(e) {
        $button = $(this);
        var key = $button.text();
        var apiMethod = apiMethods[key];
        apiMethod(); // execute api method
      });
      
      var highlight = [
        "getTimeZones",
        "getUserToken",
        "browseTags",
        "getCurrentValues",
        "getRawData",
        "getProcessedData"
      ];
      for(var i = 0; i < highlight.length; i++) {
        $('button:contains("' + highlight[i] + '")').css({
          'font-weight': 'bold',
          'text-decoration': 'underline'
        });
      }
    });
  </script>
</head>
<body>
  <h1>Views API Demo</h1>
  <p>Before using the API, the proper endpoints must be turned on to listen for requests.</p>
  <ol>
    <li>Open the "Canary Admin" program.</li>
    <li>Click on the "Views" info box on the home screen.</li>
    <li>Click on "Configuration" in the bottom tab control.</li>
    <li>Click on "Endpoints" in the side tab control.</li>
    <li>Turn on the (Web API) endpoints that you will use. Note the port numbers. These are the ports that will be listening for the Web API requests.</li>
  </ol>
  <p>Open the console window to view the results of each method call. View page source to see how the methods are called.</p>
  <ol>
    <li>Call "GetTimeZones" and keep the "timezone" that should be used when returning timestamps.</li>
    <li>Call "GetUserToken" to get a "userToken" that is required in subsequent calls.</li>
    <li>Call "BrowseTags" to load a tag array used to retrieve data in subsequent calls.</li>
    <li>Call "GetCurrentValue" to get current values of the tag array.</li>
    <li>Call "GetRawData" to get raw data of the tag array.</li>
    <li>Call "GetProcessedData" to get processed data of the tag array.</li>
    <li>Revoke the "userToken" when finished retrieving data.</li>
  </ol>
</body>
</html>